<script type="text/javascript">
    RED.nodes.registerType('isolation-forest-anomaly', {
        category: 'condition-monitoring',
        color: '#9482f1',
        defaults: {
            name: { value: "" },
            contamination: { value: 0.1, validate: RED.validators.number() },
            windowSize: { value: 100, validate: RED.validators.number() },
            numEstimators: { value: 100, validate: RED.validators.number() },
            maxSamples: { value: 256, validate: RED.validators.number() },
            // Online Learning settings
            learningMode: { value: "batch" },
            retrainInterval: { value: 50, validate: RED.validators.number() },
            adaptRate: { value: 0.1, validate: RED.validators.number() },
            persistModel: { value: false },
            outputTopic: { value: "" },
            debug: { value: false }
        },
        inputs: 1,
        outputs: 2,
        icon: "icon.png",
        label: function() {
            return this.name || "Isolation Forest Anomaly";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        outputLabels: ["normal", "anomaly"],
        paletteLabel: "Isolation Forest",
        oneditprepare: function() {
            $(".cm-section-header").on("click", function() {
                var $content = $(this).next(".cm-section-content");
                var $icon = $(this).find(".cm-collapse-icon");
                $content.slideToggle(200);
                $icon.toggleClass("fa-chevron-down fa-chevron-up");
            });
            
            // Check if ml-isolation-forest is available
            $.ajax({
                url: "isolation-forest-anomaly/status",
                method: "GET",
                success: function(data) {
                    if (data.available) {
                        $("#isolation-forest-status")
                            .removeClass("cm-badge-warning")
                            .addClass("cm-badge-success")
                            .html('<i class="fa fa-check-circle"></i> ml-isolation-forest installed');
                    } else {
                        $("#isolation-forest-status")
                            .removeClass("cm-badge-success")
                            .addClass("cm-badge-warning")
                            .html('<i class="fa fa-exclamation-triangle"></i> ml-isolation-forest not installed (using fallback)');
                    }
                },
                error: function() {
                    // Keep default warning state
                }
            });
        }
    });
</script>

<style>
    .cm-section {
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    
    .cm-section-header {
        background: linear-gradient(135deg, #9482f1 0%, #7d6bd3 100%);
        color: #fff;
        padding: 10px 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
    }
    
    .cm-section-header:hover {
        background: linear-gradient(135deg, #a896f5 0%, #9482f1 100%);
    }
    
    .cm-section-content {
        padding: 14px;
    }
    
    .cm-config-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .cm-config-item {
        display: flex;
        flex-direction: column;
    }
    
    .cm-config-item label {
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .cm-config-item input,
    .cm-config-item select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
    }
    
    .cm-config-item input:focus,
    .cm-config-item select:focus {
        border-color: #9482f1;
        outline: none;
        box-shadow: 0 0 0 2px rgba(148, 130, 241, 0.1);
    }
    
    .cm-help-text {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        font-style: italic;
    }
    
    .cm-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
    }
    
    .cm-badge-info {
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .cm-badge-success {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .cm-badge-warning {
        background: #fff3e0;
        color: #e65100;
    }
    
    .cm-info-box {
        background: #f5f5f5;
        border-left: 3px solid #9482f1;
        padding: 10px 12px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 12px;
    }
</style>

<script type="text/html" data-template-name="isolation-forest-anomaly">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-tree"></i> Isolation Forest Configuration</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content">
            <div class="cm-config-grid">
                <div class="cm-config-item">
                    <label for="node-input-contamination">
                        <i class="fa fa-sliders"></i> Contamination (0.0 - 0.5)
                    </label>
                    <input type="number" id="node-input-contamination" placeholder="0.1" step="0.01" min="0" max="0.5" value="0.1">
                    <div class="cm-help-text">Expected proportion of anomalies (default: 0.1 = 10%)</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-windowSize">
                        <i class="fa fa-window-maximize"></i> Window Size
                    </label>
                    <input type="number" id="node-input-windowSize" placeholder="100" min="10" value="100">
                    <div class="cm-help-text">Number of values for training (minimum 10)</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-numEstimators">
                        <i class="fa fa-tree"></i> Number of Trees
                    </label>
                    <input type="number" id="node-input-numEstimators" placeholder="100" min="10" max="500" value="100">
                    <div class="cm-help-text">More trees = more accurate but slower (default: 100)</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-maxSamples">
                        <i class="fa fa-database"></i> Max Samples per Tree
                    </label>
                    <input type="number" id="node-input-maxSamples" placeholder="256" min="8" value="256">
                    <div class="cm-help-text">Samples used per tree (default: 256, "auto" uses min(256, window))</div>
                </div>
            </div>
            
            <div class="cm-info-box">
                <strong>ML:</strong>
                Isolation Forest detects anomalies by isolating how easily a data point can be separated from others.
                Learns patterns automatically - no manual threshold tuning needed.
            </div>
            
            <h4 style="margin-top: 16px;"><i class="fa fa-sync"></i> Online Learning</h4>
            <div class="cm-config-grid">
                <div class="cm-config-item">
                    <label for="node-input-learningMode">
                        <i class="fa fa-brain"></i> Learning Mode
                    </label>
                    <select id="node-input-learningMode">
                        <option value="batch">Batch (retrain when buffer full)</option>
                        <option value="incremental">Incremental (retrain periodically)</option>
                        <option value="adaptive">Adaptive (auto-adjust threshold)</option>
                    </select>
                    <div class="cm-help-text">How the model adapts to new data</div>
                </div>
                
                <div class="cm-config-item" id="retrain-interval-config">
                    <label for="node-input-retrainInterval">
                        <i class="fa fa-clock"></i> Retrain Interval
                    </label>
                    <input type="number" id="node-input-retrainInterval" min="10" value="50">
                    <div class="cm-help-text">Retrain every N samples (incremental mode)</div>
                </div>
                
                <div class="cm-config-item" id="adapt-rate-config">
                    <label for="node-input-adaptRate">
                        <i class="fa fa-sliders-h"></i> Adaptation Rate
                    </label>
                    <input type="number" id="node-input-adaptRate" min="0.01" max="1" step="0.01" value="0.1">
                    <div class="cm-help-text">How fast threshold adapts (0.01-1.0)</div>
                </div>
            </div>
            
            <h4 style="margin-top: 16px;"><i class="fa fa-cog"></i> Advanced Settings</h4>
            <div class="cm-config-grid">
                <div class="cm-config-item">
                    <label for="node-input-outputTopic">
                        <i class="fa fa-tag"></i> Output Topic
                    </label>
                    <input type="text" id="node-input-outputTopic" placeholder="Leave empty to preserve original">
                    <div class="cm-help-text">Set msg.topic on output (empty = keep original)</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-debug">
                        <i class="fa fa-bug"></i> Debug Mode
                    </label>
                    <input type="checkbox" id="node-input-debug" style="width: auto; margin-top: 8px;">
                    <div class="cm-help-text">Log detailed info to Node-RED debug</div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
        <span id="isolation-forest-status" class="cm-badge cm-badge-warning">
            <i class="fa fa-spinner fa-spin"></i> Checking ml-isolation-forest...
        </span>
        <span class="cm-badge cm-badge-success">
            <i class="fa fa-check-circle"></i> 2 outputs: Normal | Anomaly
        </span>
    </div>
</script>

<script type="text/html" data-help-name="isolation-forest-anomaly">
    <p>Detects anomalies in time series data using the Isolation Forest machine learning algorithm.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The numeric value to be checked for anomalies.</dd>
        <dt class="optional">reset <span class="property-type">boolean</span></dt>
        <dd>Set to <code>true</code> to clear the buffer and retrain the model.</dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>Output 1 (top)</dt>
        <dd>Normal values with metadata</dd>
        <dt>Output 2 (bottom)</dt>
        <dd>Anomalies with metadata</dd>
    </dl>
    
    <h3>Output Properties</h3>
    <dl class="message-properties">
        <dt>isAnomaly <span class="property-type">boolean</span></dt>
        <dd>Whether the value is classified as an anomaly</dd>
        <dt>anomalyScore <span class="property-type">number</span></dt>
        <dd>Isolation score (higher = more anomalous, typically > 0.6 is anomaly)</dd>
        <dt>threshold <span class="property-type">number</span></dt>
        <dd>Current dynamic anomaly threshold</dd>
        <dt>learningMode <span class="property-type">string</span></dt>
        <dd>"batch", "incremental", or "adaptive"</dd>
        <dt>sampleCount <span class="property-type">number</span></dt>
        <dd>Total samples processed since node started</dd>
        <dt>lastRetrain <span class="property-type">number</span></dt>
        <dd>Sample count at last model retrain</dd>
        <dt>method <span class="property-type">string</span></dt>
        <dd>"isolation-forest" or "fallback-zscore" if library unavailable</dd>
        <dt>timestamp <span class="property-type">number</span></dt>
        <dd>Unix timestamp in milliseconds</dd>
    </dl>
    
    <h3>Configuration</h3>
    <ul>
        <li><b>Contamination:</b> Expected proportion of anomalies (0.01-0.5, default: 0.1 = 10%)</li>
        <li><b>Window Size:</b> Training buffer size (minimum 10, default: 100)</li>
        <li><b>Num Estimators:</b> Number of isolation trees (default: 100, more = better but slower)</li>
        <li><b>Max Samples:</b> Samples per tree (default: 256, "auto" uses min(256, windowSize))</li>
    </ul>
    
    <h3>Online Learning Modes</h3>
    <ul>
        <li><b>Batch:</b> (Default) Retrain only when buffer wraps around. Best for stable data patterns.</li>
        <li><b>Incremental:</b> Retrain every N samples (configurable). Better for evolving patterns.</li>
        <li><b>Adaptive:</b> Automatically adjust anomaly threshold based on detection patterns. Best for unknown data distributions.</li>
    </ul>
    <p><b>Retrain Interval:</b> For incremental mode, specifies how often to retrain (default: every 50 samples).</p>
    <p><b>Adaptation Rate:</b> For adaptive mode, how quickly threshold adjusts (0.01-1.0, default: 0.1).</p>
    
    <h3>How It Works</h3>
    <p>Isolation Forest isolates anomalies by randomly partitioning data. Anomalies are isolated quickly (few partitions), normal points require many partitions.</p>
    <ol>
        <li>Collects values until window size is reached</li>
        <li>Trains forest of random isolation trees</li>
        <li>Scores each new value based on average path length</li>
        <li>Retrains based on learning mode (batch, incremental, or adaptive)</li>
    </ol>
    
    <h3>Use Cases</h3>
    <ul>
        <li><b>Sensor Outliers:</b> Detect faulty readings without knowing normal range</li>
        <li><b>Multivariate Patterns:</b> Works well with high-dimensional data</li>
        <li><b>Unsupervised Detection:</b> No labeled training data required</li>
    </ul>
    
    <h3>Dependencies</h3>
    <p>Requires <code>ml-isolation-forest</code> npm package. If unavailable, automatically falls back to Z-Score method (statistical detection).</p>
    <pre>npm install ml-isolation-forest</pre>
</script>
