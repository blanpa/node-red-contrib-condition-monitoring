<script type="text/javascript">
    RED.nodes.registerType('vibration-features', {
        category: 'predictive maintenance',
        color: '#FDD835',
        defaults: {
            name: {value: ""},
            windowSize: {value: 100, required: true, validate: RED.validators.number()},
            outputMode: {value: "all"}
        },
        inputs: 1,
        outputs: 1,
        outputLabels: function(index) {
            if (this.outputMode === "separate") {
                return ["RMS", "Peak-to-Peak", "Crest Factor", "Kurtosis", "Skewness", "All Features"];
            }
            return ["Features"];
        },
        icon: "icon-predictive-maintanance.png",
        label: function() {
            return this.name || "Vibration Features";
        },
        paletteLabel: "Vibration Features",
        oneditprepare: function() {
            var node = this;
            
            // Output Mode Change Handler
            $("#node-input-outputMode").on('change', function() {
                var mode = $(this).val();
                if (mode === "separate") {
                    node.outputs = 6;
                    $("#output-mode-hint").text("6 separate outputs (RMS, Peak-to-Peak, Crest Factor, Kurtosis, Skewness, All)");
                } else {
                    node.outputs = 1;
                    $("#output-mode-hint").text("1 output with all features combined");
                }
            });
            
            // Initial trigger
            $("#node-input-outputMode").trigger('change');
        }
    });
</script>

<script type="text/html" data-template-name="vibration-features">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Vibration Features">
    </div>
    
    <div class="form-row">
        <label for="node-input-windowSize"><i class="fa fa-arrows-h"></i> Window Size</label>
        <input type="number" id="node-input-windowSize" placeholder="100" min="10" max="10000">
        <span style="margin-left: 10px; color: #666;">Number of samples for feature calculation</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-outputMode"><i class="fa fa-random"></i> Output Mode</label>
        <select id="node-input-outputMode">
            <option value="all">All features in one output</option>
            <option value="separate">Separate outputs per feature</option>
        </select>
    </div>
    
    <div class="form-row">
        <label></label>
        <span id="output-mode-hint" style="color: #666; font-size: 0.9em;"></span>
    </div>
    
    <div class="form-tips">
        <strong>üí° Tip:</strong> Use "All features" mode for dashboards and "Separate outputs" for downstream processing.
    </div>
</script>

<script type="text/html" data-help-name="vibration-features">
    <p>Extracts comprehensive vibration features from time-series data - essential for condition monitoring and predictive maintenance.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number | array</span></dt>
        <dd>Single value or array of vibration measurements</dd>
        
        <dt class="optional">unit <span class="property-type">string</span></dt>
        <dd>Unit of measurement (e.g., "m/s¬≤", "g")</dd>
    </dl>
    
    <h3>Outputs</h3>
    <h4>Mode: All Features (1 output)</h4>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Object containing all calculated features</dd>
    </dl>
    
    <h4>Mode: Separate (6 outputs)</h4>
    <ol>
        <li><b>RMS</b> - Root Mean Square value</li>
        <li><b>Peak-to-Peak</b> - Maximum amplitude range</li>
        <li><b>Crest Factor</b> - Peak / RMS ratio</li>
        <li><b>Kurtosis</b> - Distribution peakedness (spikiness)</li>
        <li><b>Skewness</b> - Distribution asymmetry</li>
        <li><b>All Features</b> - Complete feature object</li>
    </ol>
    
    <h3>Features Explained</h3>
    
    <h4>Primary Features</h4>
    <ul>
        <li><b>RMS (Root Mean Square):</b> Overall vibration energy level</li>
        <li><b>Peak-to-Peak:</b> Total amplitude range (Max - Min)</li>
        <li><b>Peak:</b> Maximum absolute value</li>
        <li><b>Crest Factor:</b> Ratio Peak/RMS
            <ul>
                <li>&lt; 2: Very smooth signal</li>
                <li>2-4: Normal operation</li>
                <li>4-6: Slight impulsive behavior</li>
                <li>&gt; 6: Strong impulsive behavior (potential damage)</li>
            </ul>
        </li>
        <li><b>Kurtosis:</b> Measures "peakedness" of distribution
            <ul>
                <li>‚âà 0: Normal distribution</li>
                <li>&gt; 3: Very peaked (indicates impacts/defects)</li>
                <li>&lt; -1: Flat distribution</li>
            </ul>
        </li>
        <li><b>Skewness:</b> Measures asymmetry
            <ul>
                <li>‚âà 0: Symmetric</li>
                <li>&gt; 0: Right-skewed (positive spikes)</li>
                <li>&lt; 0: Left-skewed (negative spikes)</li>
            </ul>
        </li>
    </ul>
    
    <h4>Additional Features</h4>
    <ul>
        <li><b>Mean:</b> Average value (DC offset)</li>
        <li><b>Standard Deviation:</b> Spread of values</li>
        <li><b>Form Factor:</b> RMS / Mean of absolute values</li>
        <li><b>Impulse Factor:</b> Peak / Mean of absolute values</li>
        <li><b>Clearance Factor:</b> Peak / (Mean of square root)¬≤</li>
        <li><b>Health Score:</b> Simplified health indicator (0-100)</li>
    </ul>
    
    <h3>Configuration</h3>
    <ul>
        <li><b>Window Size:</b> Number of samples to analyze (default: 100)
            <ul>
                <li>Larger = more stable but slower response</li>
                <li>Smaller = faster response but noisier</li>
            </ul>
        </li>
        <li><b>Output Mode:</b>
            <ul>
                <li><i>All features:</i> Single output with complete object (good for dashboards)</li>
                <li><i>Separate:</i> 6 outputs for individual processing</li>
            </ul>
        </li>
    </ul>
    
    <h3>Use Cases</h3>
    <ul>
        <li>üî© <b>Bearing Monitoring:</b> Crest Factor + Kurtosis detect early bearing defects</li>
        <li>‚öôÔ∏è <b>Gear Analysis:</b> RMS for overall condition, Crest Factor for tooth damage</li>
        <li>üîÑ <b>Motor Analysis:</b> RMS for imbalance, Kurtosis for electrical issues</li>
        <li>üìä <b>Trend Analysis:</b> Track feature changes over time</li>
        <li>ü§ñ <b>ML Input:</b> Use features as input for machine learning models</li>
    </ul>
    
    <h3>Example Output (All Features Mode)</h3>
    <pre>{
  "rms": 2.45,
  "peakToPeak": 12.3,
  "peak": 6.8,
  "crestFactor": 2.78,
  "kurtosis": 0.23,
  "skewness": -0.15,
  "mean": 0.05,
  "stdDev": 2.43,
  "formFactor": 1.11,
  "impulseFactor": 3.67,
  "clearanceFactor": 4.12,
  "healthScore": 95,
  "interpretation": {
    "crestFactor": "normal",
    "kurtosis": "normal",
    "skewness": "symmetric"
  }
}</pre>
    
    <h3>Tips</h3>
    <ul>
        <li>üìà <b>Trending:</b> Monitor changes in Crest Factor and Kurtosis over time</li>
        <li>‚ö†Ô∏è <b>Alerts:</b> Set thresholds based on baseline measurements</li>
        <li>üîç <b>Diagnosis:</b> Use multiple features together for better fault detection</li>
        <li>üìä <b>Frequency:</b> Combine with FFT Analysis for complete picture</li>
    </ul>
    
    <h3>References</h3>
    <ul>
        <li>ISO 10816: Vibration severity standards</li>
        <li>ISO 20816: Machine vibration evaluation</li>
        <li>ANSI S2.41: Vibration measurement</li>
    </ul>
</script>

