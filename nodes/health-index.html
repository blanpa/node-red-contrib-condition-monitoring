<script type="text/javascript">
    RED.nodes.registerType('health-index', {
        category: 'condition-monitoring',
        color: '#9482f1',
        defaults: {
            name: { value: "" },
            sensorWeights: { value: '{"temp":1.0,"vibration":1.5,"pressure":1.0}' },
            aggregationMethod: { value: "weighted" },
            outputScale: { value: "0-100" },
            // Threshold configuration
            healthyThreshold: { value: 80 },
            warningThreshold: { value: 60 },
            degradedThreshold: { value: 40 },
            criticalThreshold: { value: 20 },
            outputTopic: { value: "" },
            debug: { value: false },
            persistState: { value: false }
        },
        inputs: 1,
        outputs: 2,
        icon: "icon.png",
        label: function() {
            return this.name || "Health Index";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        outputLabels: ["healthy", "degraded/critical"],
        paletteLabel: "Health Index",
        oneditprepare: function() {
            var node = this;
            
            // Collapsible sections
            $(".cm-section-header").on("click", function() {
                var $content = $(this).next(".cm-section-content");
                var $icon = $(this).find(".cm-collapse-icon");
                $content.slideToggle(200);
                $icon.toggleClass("fa-chevron-down fa-chevron-up");
            });
            
            // Visual Sensor Weight Editor
            function updateSensorList() {
                var weightsJson = $("#node-input-sensorWeights").val();
                var weights = {};
                try {
                    weights = JSON.parse(weightsJson);
                } catch(e) {
                    weights = {};
                }
                
                var html = '';
                Object.keys(weights).forEach(function(sensor) {
                    html += '<div class="sensor-row" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 6px; background: #fff; border-radius: 4px;">';
                    html += '<input type="text" class="sensor-name" value="' + sensor + '" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">';
                    html += '<input type="range" class="sensor-weight-slider" min="0" max="3" step="0.1" value="' + weights[sensor] + '" style="flex: 2;">';
                    html += '<input type="number" class="sensor-weight-value" value="' + weights[sensor] + '" min="0" max="5" step="0.1" style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">';
                    html += '<button type="button" class="remove-sensor" style="background: #f44336; color: #fff; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;"><i class="fa fa-trash"></i></button>';
                    html += '</div>';
                });
                
                if (Object.keys(weights).length === 0) {
                    html = '<div style="text-align: center; color: #999; padding: 10px;">No sensors configured. Add a sensor above.</div>';
                }
                
                $("#sensor-list").html(html);
                
                // Bind events
                $(".sensor-weight-slider").on("input", function() {
                    $(this).siblings(".sensor-weight-value").val($(this).val());
                    syncWeightsToJson();
                });
                
                $(".sensor-weight-value").on("change", function() {
                    $(this).siblings(".sensor-weight-slider").val($(this).val());
                    syncWeightsToJson();
                });
                
                $(".sensor-name").on("change", function() {
                    syncWeightsToJson();
                });
                
                $(".remove-sensor").on("click", function() {
                    $(this).closest(".sensor-row").remove();
                    syncWeightsToJson();
                });
            }
            
            function syncWeightsToJson() {
                var weights = {};
                $(".sensor-row").each(function() {
                    var name = $(this).find(".sensor-name").val().trim();
                    var value = parseFloat($(this).find(".sensor-weight-value").val()) || 1.0;
                    if (name) {
                        weights[name] = value;
                    }
                });
                $("#node-input-sensorWeights").val(JSON.stringify(weights));
            }
            
            $("#add-sensor-btn").on("click", function() {
                var weightsJson = $("#node-input-sensorWeights").val();
                var weights = {};
                try {
                    weights = JSON.parse(weightsJson);
                } catch(e) {
                    weights = {};
                }
                var newName = "sensor" + (Object.keys(weights).length + 1);
                weights[newName] = 1.0;
                $("#node-input-sensorWeights").val(JSON.stringify(weights));
                updateSensorList();
            });
            
            $("#node-input-sensorWeights").on("change", updateSensorList);
            updateSensorList();
            
            // Threshold bar visualization
            function updateThresholdBar() {
                var healthy = parseInt($("#node-input-healthyThreshold").val()) || 80;
                var warning = parseInt($("#node-input-warningThreshold").val()) || 60;
                var degraded = parseInt($("#node-input-degradedThreshold").val()) || 40;
                var critical = parseInt($("#node-input-criticalThreshold").val()) || 20;
                
                // Calculate widths
                $("#bar-critical").css("flex", critical);
                $("#bar-degraded").css("flex", degraded - critical);
                $("#bar-warning").css("flex", warning - degraded);
                $("#bar-healthy").css("flex", 100 - healthy);
                
                $("#threshold-labels").text(
                    "0-" + critical + " Critical | " + 
                    critical + "-" + degraded + " Degraded | " + 
                    degraded + "-" + warning + " Warning | " +
                    warning + "-" + healthy + " | " + healthy + "-100 Healthy"
                );
            }
            
            $("#node-input-healthyThreshold, #node-input-warningThreshold, #node-input-degradedThreshold, #node-input-criticalThreshold").on("input change", updateThresholdBar);
            updateThresholdBar();
        },
        oneditsave: function() {
        }
    });
</script>

<style>
    .cm-section {
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    
    .cm-section-header {
        background: linear-gradient(135deg, #9482f1 0%, #7d6bd3 100%);
        color: #fff;
        padding: 10px 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
    }
    
    .cm-section-header:hover {
        background: linear-gradient(135deg, #a896f5 0%, #9482f1 100%);
    }
    
    .cm-section-content {
        padding: 14px;
    }
    
    .cm-config-item {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
    }
    
    .cm-config-item label {
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .cm-config-item input,
    .cm-config-item select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
    }
    
    .cm-config-item input:focus,
    .cm-config-item select:focus {
        border-color: #9482f1;
        outline: none;
        box-shadow: 0 0 0 2px rgba(148, 130, 241, 0.1);
    }
    
    .cm-help-text {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        font-style: italic;
    }
    
    .cm-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
    }
    
    .cm-badge-info {
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .cm-badge-success {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .cm-badge-warning {
        background: #fff3e0;
        color: #e65100;
    }
    
    .cm-badge-danger {
        background: #ffebee;
        color: #c62828;
    }
    
    .cm-info-box {
        background: #f5f5f5;
        border-left: 3px solid #9482f1;
        padding: 10px 12px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 12px;
    }
    
    .cm-status-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 10px;
    }
    
    .cm-status-item {
        padding: 8px;
        border-radius: 4px;
        font-size: 11px;
        text-align: center;
    }
    
    .cm-status-healthy {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .cm-status-degraded {
        background: #fff3e0;
        color: #e65100;
    }
    
    .cm-status-warning {
        background: #fff9c4;
        color: #f57f17;
    }
    
    .cm-status-critical {
        background: #ffebee;
        color: #c62828;
    }
</style>

<script type="text/html" data-template-name="health-index">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <!-- Sensor Weights -->
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-balance-scale"></i> Sensor Weights</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content">
            <div class="cm-config-item">
                <label for="node-input-sensorWeights">
                    <i class="fa fa-code"></i> Sensor Weights (JSON)
                </label>
                <input type="text" id="node-input-sensorWeights" placeholder='{"temp":1.0,"vibration":1.5,"pressure":1.0}' value='{"temp":1.0,"vibration":1.5,"pressure":1.0}'>
                <div class="cm-help-text">Higher weights = more impact on overall health</div>
            </div>
            
            <!-- Visual Sensor Weight Editor -->
            <div id="sensor-weight-editor" style="margin-top: 12px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="font-size: 12px;"><i class="fa fa-sliders"></i> Visual Editor</strong>
                    <button type="button" id="add-sensor-btn" style="font-size: 11px; padding: 4px 8px; cursor: pointer;">
                        <i class="fa fa-plus"></i> Add Sensor
                    </button>
                </div>
                <div id="sensor-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <div class="cm-info-box">
                <strong>Tip:</strong> Use the visual editor above or edit JSON directly. 
                Weight 1.0 = normal importance, 2.0 = double importance.
            </div>
        </div>
    </div>
    
    <!-- Health Thresholds -->
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-tachometer-alt"></i> Health Thresholds</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content">
            <div style="margin-bottom: 12px;">
                <div id="threshold-bar" style="height: 30px; display: flex; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                    <div id="bar-critical" style="background: #f44336; flex: 1;"></div>
                    <div id="bar-degraded" style="background: #ff9800; flex: 1;"></div>
                    <div id="bar-warning" style="background: #ffc107; flex: 1;"></div>
                    <div id="bar-healthy" style="background: #4caf50; flex: 1;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666;">
                    <span>0</span>
                    <span id="threshold-labels">Critical | Degraded | Warning | Healthy</span>
                    <span>100</span>
                </div>
            </div>
            <div class="cm-config-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="cm-config-item">
                    <label style="color: #4caf50;"><i class="fa fa-heart"></i> Healthy ≥</label>
                    <input type="number" id="node-input-healthyThreshold" min="0" max="100" value="80">
                </div>
                <div class="cm-config-item">
                    <label style="color: #ffc107;"><i class="fa fa-exclamation-circle"></i> Warning ≥</label>
                    <input type="number" id="node-input-warningThreshold" min="0" max="100" value="60">
                </div>
                <div class="cm-config-item">
                    <label style="color: #ff9800;"><i class="fa fa-exclamation-triangle"></i> Degraded ≥</label>
                    <input type="number" id="node-input-degradedThreshold" min="0" max="100" value="40">
                </div>
                <div class="cm-config-item">
                    <label style="color: #f44336;"><i class="fa fa-times-circle"></i> Critical ≥</label>
                    <input type="number" id="node-input-criticalThreshold" min="0" max="100" value="20">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Aggregation Method -->
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-cog"></i> Aggregation Method</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content">
            <div class="cm-config-item">
                <label for="node-input-aggregationMethod">
                    <i class="fa fa-calculator"></i> Method
                </label>
        <select id="node-input-aggregationMethod">
            <option value="weighted">Weighted Average</option>
            <option value="dynamic">Dynamic Weighted (Auto-Reliability)</option>
            <option value="minimum">Minimum (Worst Case)</option>
            <option value="average">Simple Average</option>
            <option value="geometric">Geometric Mean</option>
        </select>
                <div class="cm-help-text">
                    Weighted: Uses sensor weights | Dynamic: Auto-adjusts weights by reliability |
                    Minimum: Conservative (worst sensor) | Average: Equal importance | Geometric: Emphasizes poor sensors
                </div>
            </div>
        </div>
    </div>
    
    <!-- Output Settings -->
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-arrows-h"></i> Output Settings</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content" style="display: none;">
            <div class="form-row">
                <label for="node-input-outputScale"><i class="fa fa-sliders"></i> Output Scale</label>
                <select id="node-input-outputScale">
                    <option value="0-100">0-100 (Percentage)</option>
                    <option value="0-1">0-1 (Normalized)</option>
                </select>
            </div>
            <p style="font-size: 11px; color: #888; margin-top: 8px;">
                <b>0-100:</b> Traditional percentage format (e.g., 85.5%)<br>
                <b>0-1:</b> Normalized format for ML models (e.g., 0.855)
            </p>
        </div>
    </div>
    
    <!-- Advanced Settings -->
    <div class="cm-section">
        <div class="cm-section-header">
            <span><i class="fa fa-cog"></i> Advanced Settings</span>
            <i class="fa fa-chevron-down cm-collapse-icon"></i>
        </div>
        <div class="cm-section-content">
            <div class="cm-config-grid">
                <div class="cm-config-item">
                    <label for="node-input-outputTopic">
                        <i class="fa fa-tag"></i> Output Topic
                    </label>
                    <input type="text" id="node-input-outputTopic" placeholder="Leave empty to preserve original">
                    <div class="cm-help-text">Set msg.topic on output (empty = keep original)</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-debug">
                        <i class="fa fa-bug"></i> Debug Mode
                    </label>
                    <input type="checkbox" id="node-input-debug" style="width: auto; margin-top: 8px;">
                    <div class="cm-help-text">Log detailed info to Node-RED debug</div>
                </div>
                
                <div class="cm-config-item">
                    <label for="node-input-persistState">
                        <i class="fa fa-save"></i> Persist State
                    </label>
                    <input type="checkbox" id="node-input-persistState" style="width: auto; margin-top: 8px;">
                    <div class="cm-help-text">Save health history across Node-RED restarts</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Info -->
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
        <span class="cm-badge cm-badge-info">
            <i class="fa fa-heartbeat"></i> 0-100 health score
        </span>
        <span class="cm-badge cm-badge-success">
            <i class="fa fa-check-circle"></i> 2 outputs: Healthy | Degraded
        </span>
    </div>
</script>

<script type="text/html" data-help-name="health-index">
    <p>Calculates an overall equipment health index by aggregating multiple sensor readings and anomaly detection results.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">array | object</span></dt>
        <dd>Array or object containing sensor readings with optional anomaly detection metadata</dd>
    </dl>
    <p><b>Expected sensor data format:</b></p>
    <pre>{
  "temp": {
    "value": 75.2,
    "isAnomaly": false,
    "zScore": 1.2
  },
  "vibration": {
    "value": 0.5,
    "isAnomaly": true,
    "zScore": 3.5
  }
}</pre>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>Output 1 (top)</dt>
        <dd>Healthy or attention status (health index ≥ warning threshold)</dd>
        <dt>Output 2 (bottom)</dt>
        <dd>Warning, degraded, or critical status (health index < warning threshold)</dd>
    </dl>
    <p><b>Output properties:</b></p>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>Overall health index (0-100)</dd>
        <dt>status <span class="property-type">string</span></dt>
        <dd>"healthy", "attention", "warning", "degraded", or "critical"</dd>
        <dt>sensorScores <span class="property-type">object</span></dt>
        <dd>Individual health scores per sensor</dd>
        <dt>worstSensor <span class="property-type">object</span></dt>
        <dd>Sensor with lowest health score</dd>
        <dt>contributingFactors <span class="property-type">array</span></dt>
        <dd>List of issues reducing health index</dd>
        <dt>thresholds <span class="property-type">object</span></dt>
        <dd>Configured threshold values: {healthy, warning, degraded, critical}</dd>
    </dl>
    
    <h3>Configurable Thresholds</h3>
    <p>Use the visual threshold editor to set custom status boundaries:</p>
    <ul>
        <li><b>Healthy ≥</b> - Index above this is healthy (default: 80)</li>
        <li><b>Warning ≥</b> - Index above this triggers warning (default: 60)</li>
        <li><b>Degraded ≥</b> - Index above this is degraded (default: 40)</li>
        <li><b>Critical ≥</b> - Index above this is critical (default: 20)</li>
    </ul>
    <h3>Details</h3>
    <p>The health index combines multiple sensor signals into a single 0-100 score representing overall equipment condition.</p>
    <p><b>Health Score Calculation:</b></p>
    <ul>
        <li>Starts at 100 (perfect health)</li>
        <li>Deductions for anomalies (-30)</li>
        <li>Deductions for high Z-scores (-20 to -40)</li>
        <li>Deductions for high deviations (-15 to -30)</li>
        <li>Deductions for negative trends (-10)</li>
    </ul>
    <p><b>Aggregation Methods:</b></p>
    <ul>
        <li><b>Weighted Average:</b> Different sensors have different importance (configure weights)</li>
        <li><b>Dynamic Weighted:</b> Automatically adjusts weights based on sensor reliability (see below)</li>
        <li><b>Minimum (Worst Case):</b> Health equals worst sensor (conservative)</li>
        <li><b>Simple Average:</b> All sensors equally important</li>
        <li><b>Geometric Mean:</b> Emphasizes poor sensors more than average</li>
    </ul>
    
    <h3>Dynamic Weighting</h3>
    <p>The <b>Dynamic Weighted</b> method automatically adjusts sensor weights based on:</p>
    <ul>
        <li><b>Anomaly Rate:</b> Sensors with high anomaly rates (>30%) have reduced influence</li>
        <li><b>Signal Variance:</b> Very noisy sensors (high coefficient of variation) are weighted lower</li>
        <li><b>Confidence:</b> If sensor provides a confidence value, it affects the weight</li>
    </ul>
    <p><b>Output (msg.dynamicWeights):</b></p>
    <pre>{
  "sensor1": {
    "effectiveWeight": 1.2,
    "reliabilityFactor": 0.95,
    "anomalyRate": 0.05
  },
  "sensor2": {
    "effectiveWeight": 0.6,
    "reliabilityFactor": 0.4,
    "anomalyRate": 0.45
  }
}</pre>
    <p>This helps automatically downweight sensors that are unreliable or produce noisy data.</p>
    <p><b>Health Status Thresholds:</b></p>
    <ul>
        <li><b>Healthy:</b> 80-100 - Normal operation</li>
        <li><b>Degraded:</b> 60-80 - Monitor closely</li>
        <li><b>Warning:</b> 40-60 - Maintenance recommended</li>
        <li><b>Critical:</b> 0-40 - Urgent maintenance required</li>
    </ul>
    <p><b>Sensor Weights Example:</b></p>
    <pre>{"temp": 1.0, "vibration": 1.5, "pressure": 0.8}</pre>
    <p>Higher weights mean sensor has more impact on overall health (vibration is 1.5× more important than temperature).</p>
    <p><b>Use Cases:</b></p>
    <ul>
        <li>Overall equipment effectiveness (OEE)</li>
        <li>Maintenance prioritization</li>
        <li>Dashboard health indicators</li>
        <li>Predictive maintenance scheduling</li>
    </ul>
</script>
